<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>  Building a TFRecords dataset | Joao Lage | Data Scientist | ML Eng
</title>
  <link rel="canonical" href="/building-tfrecords-dataset.html">


  <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
  <link rel="stylesheet" href="/theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="/theme/css/theme.css">

  
  <meta name="description" content="How do I changed my dataset creation method">


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
  <div class="col-sm-12">
    <h1 class="title"><a href="/">Joao Lage | Data Scientist | ML Eng</a></h1>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="/pages/about-me.html">About me</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fa fa-github" href="https://github.com/lagejoao/" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fa fa-twitter" href="https://twitter.com/_joaolage" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Building a TFRecords dataset
</h1>
      <hr>
  <article class="article">
    <header>
      <ul class="list-inline">
        <li class="list-inline-item text-muted" title="2019-09-17T15:00:00+02:00">
          <i class="fa fa-clock-o"></i>
          Tue 17 September 2019
        </li>
        <li class="list-inline-item">
          <i class="fa fa-folder-open-o"></i>
          <a href="/category/tech.html">tech</a>
        </li>
          <li class="list-inline-item">
            <i class="fa fa-user-o"></i>
              <a href="/author/joao-lage.html">Joao Lage</a>          </li>
          <li class="list-inline-item">
            <i class="fa fa-files-o"></i>
              <a href="/tag/tensorflow.html">#tensorflow</a>,               <a href="/tag/keras.html">#keras</a>,               <a href="/tag/ml.html">#ml</a>          </li>
      </ul>
    </header>
    <div class="content">
      <h1>Introduction</h1>
<blockquote>
<p>For a long time I worked with pickle, JSON and CSV files in order to build a dataset that could be used to train a ML model.</p>
</blockquote>
<p>We all know the importance to have reliable, reusable and portable datasets when training any model.</p>
<p>As we know, pickle files show some disadvantages:</p>
<ul>
<li>No compression</li>
<li>Assumes you will have the same packages when decoding the file (example: numpy)</li>
<li>You cannot stream it from disk since you have to read and decode the file/part as a whole first</li>
</ul>
<p><strong>What happens next?</strong> - Let me present you TFRecords!</p>
<h1>Creating the Dataset</h1>
<p>What is a TFRecords file?</p>
<blockquote>
<p>"To read data efficiently it can be helpful to serialize your data and store it in a set of files (...)"
src: <a href="https://www.tensorflow.org/tutorials/load_data/tf_records">TFRecords tutorials</a></p>
</blockquote>
<p>TFRecords take advantage of <a href="https://developers.google.com/protocol-buffers/">protocol buffers</a> to efficiently create a cross-platform structure of the data to be saved. The saved data is a sequence of binary records.</p>
<h3>How do I start?</h3>
<p>Let's pretend our dataset is made of images, descriptions and labels. Labels will be our targets for future use.
First we will need to define a protobuf and <code>tf.train.Example</code> will ease that work for us:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>


<span class="k">def</span> <span class="nf">serialize_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;description_index&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">description</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s2">&quot;description_value&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">description</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span>
            <span class="n">bytes_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">image</span><span class="p">])</span>
        <span class="p">),</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">])),</span>
    <span class="p">}</span>

    <span class="n">example_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">example_proto</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</pre></div>


<p>The above snippet creates a structure holding a sparse vector representation for textual descriptions, a byte string for images and a list for labels . If you want to encode your text as a sequence you can easily do it without the need of having both indices and values - just values will be enough.</p>
<p>In regard to images, this example assumes that each image was downloaded, resized and saved previously into disk and can be loaded through its image path.</p>
<p>At the moment, TFRecords support <a href="https://www.tensorflow.org/tutorials/load_data/tf_records#data_types_for_tfexample">three generic types</a>, <code>BytesList</code>, <code>FloatList</code> and <code>Int64List</code>, but they can be coerced into many other data types.</p>
<h2>How do I create a TFRecords file?</h2>
<p>After having the dataset split and the vectorisers fitted, you can loop through the data splits, create a binary representation of each data point and save it to a <code>.tfrecords</code> file:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>


<span class="n">datasets</span> <span class="o">=</span> <span class="p">[(</span><span class="n">train</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;.tfrecords&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">python_io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;image_path&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">text_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]])</span>
            <span class="p">)</span>

            <span class="n">label_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>

            <span class="n">example</span> <span class="o">=</span> <span class="n">serialize_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>


<p>For reproducibility purposes, <code>text_encoder</code> is a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html">CountVectorizer</a> object and <code>label_encoder</code> is a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.LabelBinarizer.html">LabelBinarizer</a> object.</p>
<p><strong>Tip:</strong> In case of using encoders for text and/or targets, I recommend to save their configuration in order to dynamically load the number of unique tokens and/or classes.</p>
<p>After running the snippets above you will create three files <code>train.tfrecords</code>, <code>val.tfrecords</code> and <code>test.tfrecords</code>!</p>
<h2>How do I read a TFRecord file?</h2>
<p>First we need to create a representation of the feature we want to decode from each TFRecord:</p>
<div class="highlight"><pre><span></span><span class="n">feature_description</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseFeature</span><span class="p">(</span><span class="n">index_key</span><span class="o">=</span><span class="s2">&quot;description_index&quot;</span><span class="p">,</span> <span class="n">value_key</span><span class="o">=</span><span class="s2">&quot;description_value&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">description_max_features</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>


<p>Luckily we have the ability to turn an array of indices and an array of values into a sparse feature without much hassle with <code>tf.SparseFeature</code>, just by specifying where to read the indices, values and the maximum length of the sparse representation. Please note that for every example: <code>len(indices) == len(values)</code> and <code>indices</code> should be contained in <code>[0,...,max_features-1]</code>.</p>
<p>Then we create a parsing function that reads the byte string of each example and decodes it:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_parse_function</span><span class="p">(</span><span class="n">example_proto</span><span class="p">):</span>
    <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example_proto</span><span class="p">,</span> <span class="n">feature_description</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

    <span class="n">image_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">decode_raw</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span><span class="n">image</span><span class="p">,</span>
    <span class="p">},</span> <span class="n">label</span>
</pre></div>


<p><strong>Tip:</strong> If you wish to turn a sparse tensor into dense you can use <a href="https://www.tensorflow.org/api_docs/python/tf/sparse/to_dense">tf.sparse.to_dense</a>.</p>
<p><strong>Tip:</strong> Using pre-trained imagenet weights?</p>
<p>If using an image model initialised with imagenet weights you should subtract the channel mean on each pixel using the below function. Also, channels will be swapped from RGB to BGR. This preprocessing stage guarantees that you will be sourcing images to the model following the same pixel value distribution per channel from the imagenet's dataset.</p>
<p>The code block below is a simplified version of the current Keras <a href="https://github.com/keras-team/keras-applications/blob/master/keras_applications/imagenet_utils.py#L93">implementation</a> that assumes the <code>x</code> tensor to have color channels in the last dimension and channels input order should be RGB.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_symbolic_input</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span>
    <span class="n">data_format</span> <span class="o">=</span> <span class="s2">&quot;channels_last&quot;</span>

    <span class="c1"># &#39;RGB&#39;-&gt;&#39;BGR&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[</span><span class="mf">103.939</span><span class="p">,</span> <span class="mf">116.779</span><span class="p">,</span> <span class="mf">123.68</span><span class="p">]</span>

    <span class="n">mean_tensor</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">))</span>

    <span class="c1"># Zero-center by mean pixel</span>
    <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">backend</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">mean_tensor</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span>
            <span class="n">backend</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">mean_tensor</span><span class="p">)),</span>
            <span class="n">mean_tensor</span><span class="p">,</span>
            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">bias_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean_tensor</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;channels_last&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</pre></div>


<p>Finally, we create an helper to reads the datasets:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_parse_function</span><span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s2">&quot;train.tfrecords&quot;</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s2">&quot;val.tfrecords&quot;</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="s2">&quot;test.tfrecords&quot;</span><span class="p">)</span>
</pre></div>


<h1>Fitting a model</h1>
<p>A TFRecord dataset is also know by its versatility since it can be used when fitting a <code>tf.keras.Model</code> (see <a href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">docs</a>) and also when training an instance of <code>tf.estimator.Estimator</code> (see: <a href="https://www.tensorflow.org/api_docs/python/tf/estimator/Estimator">docs</a> and <a href="https://www.tensorflow.org/guide/estimators">guide</a>).</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">input_fn_train</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">input_fn_eval</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>


<p>Voilà! You are now able to feed batches of tfrecords into your model!</p>
    </div>
  </article>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
      <li class="list-inline-item"><a href="/authors.html">Authors</a></li>
    <li class="list-inline-item"><a href="/archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="/categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="/tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>
</body>

</html>